<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database CRUD Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #adminPanel { display: none; }
        .login-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
        }
        .login-content { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            width: 300px; 
            color: #333;
        }
        .login-input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            margin-bottom: 15px;
        }
        .login-btn {
            width: 100%;
            padding: 10px;
            background: #007bff;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .cancel-btn {
            width: 100%;
            padding: 10px;
            background: #6c757d;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div style="text-align: right; margin-bottom: 20px; padding: 10px; background: #e9ecef; border-radius: 4px;">
        <button id="loginBtn" onclick="showLoginModal()">Admin Login</button>
        <button id="logoutBtn" onclick="auth.signOut()" style="display: none;">Logout</button>
    </div>
    
    <h1>Database CRUD Operations Test</h1>
    
    <div id="loginModal" class="login-modal">
        <div class="login-content">
            <h3>Admin Login</h3>
            <form id="loginForm">
                <input type="email" id="email" placeholder="Enter your email" required class="login-input" value="lifeexperience@example.com">
                <input type="password" id="password" placeholder="Enter your password" required class="login-input">
                <button type="submit" class="login-btn">Login</button>
                <button type="button" onclick="closeLoginModal()" class="cancel-btn">Cancel</button>
            </form>
            <div id="loginError" style="color: red; margin-top: 10px; display: none;"></div>
        </div>
    </div>
    
    <div id="adminPanel">
        <div class="test-section">
            <h2>Database Connection Test</h2>
            <button onclick="testConnection()">Test Connection</button>
            <div id="connectionResults"></div>
        </div>

        <div class="test-section">
            <h2>Experiences Table Tests</h2>
            <button onclick="testExperiencesCRUD()">Run Experiences CRUD Test</button>
            <div id="experiencesResults"></div>
        </div>

        <div class="test-section">
            <h2>Bucket List Table Tests</h2>
            <button onclick="testBucketListCRUD()">Run Bucket List CRUD Test</button>
            <div id="bucketListResults"></div>
        </div>

        <div class="test-section">
            <h2>Quick Add Experience Test</h2>
            <button onclick="quickAddTest()">Test Add Single Experience</button>
            <div id="quickAddResults"></div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/db.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        function logResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function testConnection() {
            clearResults('connectionResults');
            logResult('connectionResults', 'Testing database connection...', 'info');
            
            try {
                if (!supabase) {
                    throw new Error('Supabase client not initialized');
                }
                const { data, error } = await supabase.from('lifeexperiences').select('count', { count: 'exact' });
                if (error) throw error;
                logResult('connectionResults', 'âœ… Database connection successful!', 'success');
                logResult('connectionResults', `Current experiences count: ${data.length}`, 'info');
            } catch (error) {
                logResult('connectionResults', `âŒ Connection failed: ${error.message}`, 'error');
            }
        }

        async function testExperiencesCRUD() {
            clearResults('experiencesResults');
            logResult('experiencesResults', 'Starting Experiences CRUD test...', 'info');
            
            let testExperienceId = null;

            try {
                const testExperience = {
                    title: 'Test Experience - CRUD Test',
                    date: '2024-01-01',
                    category: 'learning',
                    description: 'This is a test experience for CRUD operations',
                    rating: 8
                };

                logResult('experiencesResults', '1. Testing CREATE operation...', 'info');
                const createdExp = await db.addExperience(testExperience);
                testExperienceId = createdExp.id;
                logResult('experiencesResults', `âœ… CREATE: Experience created with ID ${testExperienceId}`, 'success');

                logResult('experiencesResults', '2. Testing READ operation...', 'info');
                const experiences = await db.getExperiences();
                const foundExp = experiences.find(exp => exp.id === testExperienceId);
                if (foundExp) {
                    logResult('experiencesResults', `âœ… READ: Found experience "${foundExp.title}"`, 'success');
                } else {
                    throw new Error('Created experience not found in READ operation');
                }

                logResult('experiencesResults', '3. Testing DELETE operation...', 'info');
                const { error: deleteError } = await supabase
                    .from('lifeexperiences')
                    .delete()
                    .eq('id', testExperienceId);
                
                if (deleteError) throw deleteError;
                logResult('experiencesResults', 'âœ… DELETE: Experience deleted successfully', 'success');
                
                logResult('experiencesResults', 'ðŸŽ‰ All CRUD operations completed successfully!', 'success');
            } catch (error) {
                logResult('experiencesResults', `âŒ CRUD Test failed: ${error.message}`, 'error');
            }
        }

        async function testBucketListCRUD() {
            clearResults('bucketListResults');
            logResult('bucketListResults', 'Starting Bucket List CRUD test...', 'info');
            
            try {
                const testItem = {
                    title: 'Test Bucket Item',
                    description: 'Test description',
                    category: 'personal',
                    priority: 'medium',
                    completed: false
                };

                const createdItem = await db.addBucketItem(testItem);
                logResult('bucketListResults', `âœ… Bucket item created with ID ${createdItem.id}`, 'success');
                
                await db.deleteBucketItem(createdItem.id);
                logResult('bucketListResults', 'âœ… Bucket item deleted successfully', 'success');
            } catch (error) {
                logResult('bucketListResults', `âŒ Test failed: ${error.message}`, 'error');
            }
        }

        async function quickAddTest() {
            clearResults('quickAddResults');
            try {
                const quickExp = {
                    title: `Quick Test - ${new Date().toLocaleTimeString()}`,
                    date: new Date().toISOString().split('T')[0],
                    category: 'other',
                    description: 'Quick test experience',
                    rating: 7
                };

                const result = await db.addExperience(quickExp);
                logResult('quickAddResults', `âœ… Experience added with ID: ${result.id}`, 'success');
            } catch (error) {
                logResult('quickAddResults', `âŒ Quick add failed: ${error.message}`, 'error');
            }
        }

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                await auth.signIn(email, password);
                closeLoginModal();
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline-block';
            } catch (error) {
                document.getElementById('loginError').textContent = error.message;
                document.getElementById('loginError').style.display = 'block';
            }
        });

        // Wait for scripts to load before initializing
        setTimeout(() => {
            auth.checkAuth().then(() => {
                if (auth.isAdmin()) {
                    document.getElementById('adminPanel').style.display = 'block';
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('logoutBtn').style.display = 'inline-block';
                }
            });
        }, 1000);
    </script>
</body>
</html>